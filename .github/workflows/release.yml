name: Create Release

on:
  workflow_dispatch:
    inputs:
      release_notes:
        description: 'Release notes (markdown supported)'
        required: false
        default: ''
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        default: false
        type: boolean
      draft:
        description: 'Create as draft'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  actions: read

jobs:
  prepare-release:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract-version.outputs.version }}
      tag: ${{ steps.extract-version.outputs.tag }}
      release-notes: ${{ steps.generate-notes.outputs.notes }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for release notes generation

      - name: Setup uv
        uses: astral-sh/setup-uv@v7
        with:
          python-version: "3.11"
          enable-cache: true

      - name: Extract version from pyproject.toml
        id: extract-version
        run: |
          # Extract version using Python
          VERSION=$(uv run python -c "
          import tomllib
          with open('pyproject.toml', 'rb') as f:
              data = tomllib.load(f)
          print(data['project']['version'])
          ")
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT
          
          echo "üì¶ Extracted version: $VERSION"
          echo "üè∑Ô∏è Tag will be: v$VERSION"

      - name: Check if tag already exists
        run: |
          if git tag -l "v${{ steps.extract-version.outputs.version }}" | grep -q "v${{ steps.extract-version.outputs.version }}"; then
            echo "‚ùå Tag v${{ steps.extract-version.outputs.version }} already exists!"
            echo "Please update the version in pyproject.toml before creating a release."
            exit 1
          else
            echo "‚úÖ Tag v${{ steps.extract-version.outputs.version }} is available"
          fi

      - name: Generate automatic release notes
        id: generate-notes
        run: |
          # Get the latest tag to generate notes since then
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -z "$LATEST_TAG" ]; then
            echo "üìù No previous tags found, generating notes from first commit"
            COMMIT_RANGE="$(git rev-list --max-parents=0 HEAD)..HEAD"
          else
            echo "üìù Generating release notes since $LATEST_TAG"
            COMMIT_RANGE="$LATEST_TAG..HEAD"
          fi
          
          # Generate commit log
          echo "## üöÄ Changes in v${{ steps.extract-version.outputs.version }}" > release_notes.md
          echo "" >> release_notes.md
          
          # Get commits and categorize them
          FEATURES=$(git log --format="- %s" --grep="feat\|feature" $COMMIT_RANGE | head -20)
          FIXES=$(git log --format="- %s" --grep="fix\|bug" $COMMIT_RANGE | head -20)
          DOCS=$(git log --format="- %s" --grep="docs\|doc" $COMMIT_RANGE | head -10)
          OTHER=$(git log --format="- %s" --invert-grep --grep="feat\|feature\|fix\|bug\|docs\|doc" $COMMIT_RANGE | head -10)
          
          if [ -n "$FEATURES" ]; then
            echo "### ‚ú® Features" >> release_notes.md
            echo "$FEATURES" >> release_notes.md
            echo "" >> release_notes.md
          fi
          
          if [ -n "$FIXES" ]; then
            echo "### üêõ Bug Fixes" >> release_notes.md
            echo "$FIXES" >> release_notes.md
            echo "" >> release_notes.md
          fi
          
          if [ -n "$DOCS" ]; then
            echo "### üìö Documentation" >> release_notes.md
            echo "$DOCS" >> release_notes.md
            echo "" >> release_notes.md
          fi
          
          if [ -n "$OTHER" ]; then
            echo "### üîß Other Changes" >> release_notes.md
            echo "$OTHER" >> release_notes.md
            echo "" >> release_notes.md
          fi
          
          # Add user notes if provided
          if [ -n "${{ github.event.inputs.release_notes }}" ]; then
            echo "### üìã Release Notes" >> release_notes.md
            echo "" >> release_notes.md
            echo "${{ github.event.inputs.release_notes }}" >> release_notes.md
            echo "" >> release_notes.md
          fi
          
          # Add installation instructions
          echo "## üì¶ Installation" >> release_notes.md
          echo "" >> release_notes.md
          echo "Use this action in your workflow:" >> release_notes.md
          echo '```yaml' >> release_notes.md
          echo "- name: Sync CITATION.cff" >> release_notes.md
          echo "  uses: recite/citation-sync@v${{ steps.extract-version.outputs.version }}" >> release_notes.md
          echo "  with:" >> release_notes.md
          echo "    commit: true" >> release_notes.md
          echo '```' >> release_notes.md
          
          # Output the notes
          {
            echo 'notes<<EOF'
            cat release_notes.md
            echo EOF
          } >> $GITHUB_OUTPUT
          
          echo "üìã Generated release notes:"
          cat release_notes.md

  run-tests:
    runs-on: ubuntu-latest
    needs: prepare-release
    strategy:
      matrix:
        python-version: ["3.11", "3.12", "3.13"]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup uv
        uses: astral-sh/setup-uv@v7
        with:
          python-version: ${{ matrix.python-version }}
          enable-cache: true

      - name: Install dependencies
        run: |
          uv sync --extra dev

      - name: Run tests
        run: |
          uv run pytest tests/ -v
          
      - name: Run linting
        run: |
          uv run ruff check .
          uv run ruff format --check .

      - name: Test action functionality
        run: |
          # Test basic functionality
          uv run python src/sync_citation.py
          
          # Test with different configurations
          UPDATABLE_FIELDS="title,version" uv run python src/sync_citation.py
          EXCLUDE_FIELDS="date-released" uv run python src/sync_citation.py

  create-release:
    runs-on: ubuntu-latest
    needs: [prepare-release, run-tests]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup uv
        uses: astral-sh/setup-uv@v7
        with:
          python-version: "3.11"
          enable-cache: true

      - name: Update CITATION.cff with new version and release date
        run: |
          echo "üìù Updating CITATION.cff for release v${{ needs.prepare-release.outputs.version }}"
          
          # Set environment variables for the sync script
          export CUSTOM_FIELDS='{"date-released": "'$(date -I)'"}'
          
          # Run sync to update CITATION.cff
          uv run python src/sync_citation.py
          
          # Check if CITATION.cff was updated
          if git diff --quiet CITATION.cff; then
            echo "‚úÖ CITATION.cff is already up to date"
          else
            echo "üìù CITATION.cff updated with new version and date"
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            git add CITATION.cff
            git commit -m "chore: update CITATION.cff for v${{ needs.prepare-release.outputs.version }} release"
            git push
          fi

      - name: Create and push tag
        run: |
          echo "üè∑Ô∏è Creating tag ${{ needs.prepare-release.outputs.tag }}"
          
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          git tag -a "${{ needs.prepare-release.outputs.tag }}" -m "Release v${{ needs.prepare-release.outputs.version }}"
          git push origin "${{ needs.prepare-release.outputs.tag }}"
          
          echo "‚úÖ Tag created and pushed"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare-release.outputs.tag }}
          name: "Release v${{ needs.prepare-release.outputs.version }}"
          body: ${{ needs.prepare-release.outputs.release-notes }}
          draft: ${{ github.event.inputs.draft }}
          prerelease: ${{ github.event.inputs.prerelease }}
          generate_release_notes: false  # We generate our own
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "üéâ Release v${{ needs.prepare-release.outputs.version }} created successfully!"
          echo "üì¶ Tag: ${{ needs.prepare-release.outputs.tag }}"
          echo "üîó Release URL: ${{ github.server_url }}/recite/citation-sync/releases/tag/${{ needs.prepare-release.outputs.tag }}"
          echo ""
          echo "### Next steps:"
          echo "- Update any documentation that references the old version"
          echo "- Announce the release to users"
          echo "- Monitor for any issues with the new release"